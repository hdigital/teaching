---
title: "Regressions-Diagnose Â· ğŸ”"
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_float: yes
---


```{r, message=FALSE}
library(broom)        # tidy model data
library(performance)  # regression diagnostic
library(estimatr)     # robust standard-errors

library(tidyverse)
ggplot2::theme_set(theme_minimal())
```


```{r, message=FALSE}
##  tidy lm model results with broom

tidy_lm <- function(fit) {
  tidy(fit) %>% mutate_if(is.numeric, round, 2)
}

glance_lm <- function(fit) {
  glance(fit) %>% 
    select(r.squared, adj.r.squared, statistic, p.value, df, nobs) %>% 
    mutate_if(is.numeric, round, 2)
}
```


# Wunsch I Â· Perfekte Daten

Eine Fee ğŸ§š die WÃ¼nsche ğŸ§ erfÃ¼llt?

![](bilder/fair.jpg)

Den Wunsch ğŸª„ nach perfekten Daten ğŸ“ˆ erfÃ¼llt sie nicht ğŸ˜¥.
 
Die Fee ğŸ§š Ã¼berlegt, nutzt [__R__](https://education.rstudio.com/learn/beginner/) ğŸ‘©â€ğŸ’» und schafft fast perfekte Daten ğŸ“ˆ.

```{r}
param_const <- 500
param_alter <- 25

n <- 1000
sd_einkommen <-  100

dt_raw <- 
  tibble( 
    id = 1:n,
    alter = seq(20, 60, length.out = n) %>% round(2),
    einkommen_linear = round(param_const + param_alter*alter)
    ) %>% 
  mutate(einkommen = round(einkommen_linear + rnorm(n, sd = sd_einkommen)))
```


$$ Einkommen_{ID} = 500 + 25 \cdot Alter_{ID} \: + ( \: Fehler_{ID} \: )$$

```{r}
ggplot(dt_raw, aes(x = alter, y = einkommen)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = lm)
```


# Wunsch II Â· Diagnose fÃ¼r SoWis

Die Studierenden ğŸ™‡ğŸ™‡ğŸ™‡ğŸ™‡ hatten einen eigenen Wunsch ğŸª„ an die Fee ğŸ§š.

Kannst Du uns Regressions-Diagnose ğŸ“ˆ mit einer sozialwissenschaftlichen Geschichte ğŸ“š erklÃ¤ren?

![](bilder/fair.jpg)

## Daten Fee

Wir stellen uns Postbeamte ğŸ“¯ vor die regelmÃ¤ÃŸig LohnerhÃ¶hungen ğŸ’° strikt nach dem SenioritÃ¤tsprinzip ğŸ¥¸ erhalten. 

Wir haben also ein Modell ğŸ“ˆ bei dem das __Einkommen__ ğŸ’° vom __Alter__ ğŸ§‘ğŸ‘´ abhÃ¤ngt.

![](bilder/postbeamte.jpg)

Das wahre Einkommen ğŸ’° (`einkommen_linear`) ist uns bekannt und unsere beobachteten Daten ğŸ•µï¸ (`einkommen`) weichen davon normal-verteilt ğŸ§® ab

So hat die Fee ğŸ§š uns die Daten ğŸ“Š gegeben.

```{r}
ggplot(dt_raw, aes(x = alter, y = einkommen)) +
  geom_point(alpha = 0.2) +
  geom_jitter(aes(y = einkommen_linear),
              width = 0.1, alpha = 0.5,
              colour = "darkgreen", shape = ".")

DT::datatable(dt_raw)
```

## Modell (fast) perfekt

Wir bekommen schÃ¶ne Ergebnisse bei der SchÃ¤tzung des Modells. ğŸ˜„

```{r}
fit <- lm(einkommen ~ alter, data = dt_raw)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```


## Annahmen (1-7)

1. korrekte Spezifikation (LinearitÃ¤t)
2. Erwartungswert der Residuen (lokal) = 0
3. Normalverteilte Residuen
4. VarianzhomogenitÃ¤t (gleichmÃ¤ÃŸige Streuung Residuen)
5. BerÃ¼cksichtigung einflussreicher FÃ¤lle (keine Ausreisser)
6. _keine_ MultikollinearitÃ¤t (geringe Korrelation unabhÃ¤ngiger Variablen)
7. _keine_ Autokorrelation der Residuen (insbes. Zeitreihen)


## Korrekte Spezifikation

### Dritt-Variablen

![](bilder/brieftraeger-frauen.jpg)

BrieftrÃ¤ger âœ‰ï¸ arbeiten oft nur halbtags ğŸ• und verdienen ğŸ’° dann auch nur die HÃ¤lfte.

```{r}
dt <-
  dt_raw %>% 
  mutate(einkommen = if_else(id %% 3 == 0, einkommen/2 + rnorm(n, sd = 50), einkommen),
         halbtags = if_else(id %% 3 == 0, "ja", "nein") %>% fct_relevel("ja", after = Inf))

ggplot(dt, aes(x = alter, y = einkommen, colour = halbtags)) +
  geom_point(alpha = 0.2)
```

Ohne Dritt-Variable ğŸ˜Ÿ

```{r}
fit <- lm(einkommen ~ alter, data = dt)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```

Mit Dritt-Variable ğŸ™‚

```{r}
fit <- lm(einkommen ~ alter + halbtags, data = dt)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```

Noch besser mit Dritt-Variable und Interaktions-Effekt ğŸ˜ƒ

```{r}
fit <- lm(einkommen ~ alter*halbtags, data = dt)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```

### Funktionale Form

![](bilder/bundespost.jpg)

Bei der Bundespost ğŸ“¯ wurde eine Bezahlung ğŸ’° nach Humankapital eingefÃ¼hrt. 

Es wurde erkannt, dass bei jungen Beamten ğŸ§‘ die ProduktivitÃ¤t stÃ¤rker wÃ¤chst als bei Ã„lteren ğŸ§“. Daher erhalten sie hÃ¶here LohnzuwÃ¤chse ğŸ’°.

```{r}
dt <-
  dt_raw %>% 
  mutate(einkommen_polynom = -300 + 80*alter - 0.725*alter^2,
         einkommen = einkommen_polynom + rnorm(n, sd = sd_einkommen))

ggplot(dt, aes(x = alter, y = einkommen)) +
  geom_point(alpha = 0.2) +
    geom_jitter(aes(y = einkommen_polynom),
                width = 0.1, alpha = 0.5,
                colour = "darkblue", shape = ".")
```
Ein lineares Modell ist falsch spezifiziert. ğŸ˜Ÿ Die Regressions-Diagnose zeigt dies. â˜ï¸

```{r}
fit <- lm(einkommen ~ alter, data = dt)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```

Korrekt ist ein Modell mit einem Polynom (hier einem quadratischem Term). ğŸ˜ƒ

```{r}
fit <- lm(einkommen ~ alter + I(alter^2), data = dt)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```

( Den R Hinweis auf Multi-KollinearitÃ¤t ignorieren wir einfach. NatÃ¼rlich gibt es einen Zusammenhang zwischen `alter` und dem quadrierten `alter^2`. )


## VarianzhomogenitÃ¤t

![](bilder/minister.jpg)

Bei der Post ğŸ“¯ haben hohe Beamte und Minster ein hÃ¶heres Einkommen ğŸ’° als einfache Beamte. Aber nicht alle werden hohe Beamte ğŸ§‘â€ğŸ’¼ oder [Post-Minister](https://de.wikipedia.org/wiki/Christian_Schwarz-Schilling) ğŸ¤.

```{r}
dt <- dt_raw %>% mutate(einkommen = einkommen_linear + id/500 * rnorm(n, sd = sd_einkommen))

ggplot(dt, aes(x = alter, y = einkommen)) +
  geom_point(alpha = 0.2) +
    geom_jitter(aes(y = einkommen_linear),
                width = 0.1, alpha = 0.5,
                colour = "darkgreen", shape = ".")
```

Im Standard-Modell erhalten wir verzerrte Standard-Fehler. ğŸ˜Ÿ

```{r}
fit <- lm(einkommen ~ alter, data = dt)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```

Besser ist ein Modell mit _robusten_ ğŸ’ª Standard-Fehlern. ğŸ˜„

```{r}
fit <- lm_robust(einkommen ~ alter, data = dt)
tidy_lm(fit)
glance(fit) %>% mutate_if(is.numeric, round, 2) 
```

## MultikollinearitÃ¤t

![](bilder/brieftraeger-gruppe.jpg)

Ã„ltere ğŸ‘´ğŸ‘µ Postbeamte ğŸ“¯ sind kleiner als JÃ¼ngere ğŸ‘§ğŸ‘¦.

```{r}
dt <- dt_raw %>% mutate(groesse_cm = round(seq(180, 160, length.out = n) + rnorm(n, sd = 2.5), 3))

ggplot(dt, aes(x = alter, y = groesse_cm)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = lm)
```
Es gibt dann auch einen Zusammenhang ğŸ“‰ zwischen `groesse_cm` ğŸ‘µ und `einkommen` ğŸ’°, natÃ¼rlich keinen kausalen âš™ï¸.

```{r}
ggplot(dt, aes(x = groesse_cm, y = einkommen)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = lm)
```

```{r}
fit <- lm(einkommen ~ groesse_cm, data = dt)
tidy_lm(fit)
glance_lm(fit)
```

Nehmen wir `alter` ğŸ‘µ und `groesse_cm` ğŸ“ in einem Modell auf ğŸ“‰ haben wir MultikollinearitÃ¤t ğŸ”— ğŸ˜Ÿ

```{r}
fit <- lm(einkommen ~ alter + groesse_cm, data = dt)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```


MultikollinearitÃ¤t im Modell ğŸ“‰  erkennen ğŸ•µï¸ wir auch  an der sehr starken Korrellation der unabhÃ¤ngigen Variablen.

```{r}
dt %>% 
  select(alter, einkommen) %>% 
  cor() %>% 
  as_tibble() %>% 
  mutate_all(round, 2)
```


## Ausreisser

![](bilder/fernmeldeamt.jpg)

Bei der DatenÃ¼bertragung ğŸ“¡ gab es einen Fehler âš ï¸ und die letzte Ziffer ğŸ”¢ wurde bei einigen Gehaltsangaben ğŸ’° entfernt. 

```{r}
id_random <- runif(80, min = 1, max = n) %>% round()

dt <-
  dt_raw %>% 
  mutate(einkommen = if_else(id %in% id_random, round(einkommen/10), einkommen))

ggplot(dt, aes(x = alter, y = einkommen)) +
  geom_point(alpha = 0.2)
```

Wir erhalten eine verzerrte SchÃ¤tzung. ğŸ˜Ÿ

```{r}
fit <- lm(einkommen ~ alter, data = dt)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```

Die falschen Beobachtungen mÃ¼ssen wir entfernen (oder korrigieren). ğŸ˜ƒ

```{r}
dt_tmp <- dt %>% filter(einkommen > 500)

fit <- lm(einkommen ~ alter, data = dt_tmp)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```



## Autokorrelation

![](bilder/telefonzentrale.jpg)

Die Postbeamten ğŸ“¯ wurden 2010 und 2020 ğŸ“… nach ihrem Einkommen ğŸ’° befragt. â˜ï¸

```{r}
dt_tmp <-
  dt_raw %>% 
  mutate(einkommen = round(einkommen - param_alter*10 + rnorm(n, sd = 10)),
         alter = alter - 10,
         befragung = 2010) %>% 
  filter(alter >= 20)

dt <-
  dt_raw %>% 
  mutate(befragung = 2020) %>% 
  rbind(dt_tmp) %>% 
  arrange(id, befragung) %>% 
  relocate(befragung, .after = id)

DT::datatable(dt %>% filter(id > 500))  # Daten ab ID 500 um Panel-Struktur zu verdeutlichen 
```

Postbeamte ğŸ“¯ die 2010  ğŸ“… Ã¤lter als 50 waren sind inzwischen in Pension ğŸ‘µ und haben an der 2020 Befragung â˜ï¸ nicht mehr teilgenommen.

```{r}
dt_tmp <- dt %>% mutate(befragung = factor(befragung))

ggplot(dt_tmp, aes(x = alter, y = einkommen, colour = befragung)) +
  geom_point(alpha = 0.2)
```

Im Modell (n = 1750) sind Beobachtungen (und Residuen) nicht mehr unabhÃ¤ngig. ğŸ˜Ÿ Wir haben ja viele zweimal befragt. â˜ï¸

```{r}
fit <- lm(einkommen ~ alter, data = dt_tmp)
tidy_lm(fit)
glance_lm(fit)
check_model(fit)
```

# Aufgabe

![](bilder/radioquiz.jpg)

Diskutieren Sie ğŸ™‡ğŸ™‡ğŸ™‡ die Regressions-Annahmen  ğŸ“ˆ  und zeigen Sie ob und wie Verletzungen ğŸ¥ der Annahmen erkannt ğŸ•µï¸  werden kÃ¶nnen.

---

# Quellen

+ <https://commons.wikimedia.org/wiki/File:SophieAndersonTakethefairfaceofWoman.jpg>
+ <https://commons.wikimedia.org/wiki/File:Bundesarchiv_Bild_183-63142-0001,_Cottbus,_Brieftr%C3%A4gerinnen.jpg>
+ <https://commons.wikimedia.org/wiki/File:Bundesarchiv_Bild_183-1990-0924-020,_Gera,_Protest_von_Post-Gewerkschaftern.jpg>
+ <https://commons.wikimedia.org/wiki/File:Bundesarchiv_Bild_183-U0205-0010,_Berlin,_Tag_des_Post-_und_Fernmeldewesens,_Vorbereitung.jpg>
+ <https://commons.wikimedia.org/wiki/File:Bundesarchiv_Bild_183-59111-0002,_Berlin,_Postamt_N_58,_Brieftr%C3%A4ger.jpg>
+ <https://commons.wikimedia.org/wiki/File:Telefonzentrale_bei_der_2.Infanteriedivision_(BildID_15705125).jpg>
+ <https://commons.wikimedia.org/wiki/File:Radioquiz_%22Allein_gegen_alle%22_aus_dem_Ratssaal_(Kiel_45.567).jpg>

---

![](bilder/fair.jpg)